---
title: "A guide to tactical voting for 2017 election"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: https://github.com/nickforr/ukEelctions
    theme: simplex

---

```{r global, include=FALSE}
library(flexdashboard)
library(shiny)
library(raster) #Need to put raster before tidyverse to avoid masking select
library(tidyverse)
library(readxl)
library(scales)
library(hrbrthemes)
library(viridis)
library(leaflet)

if (!file.exists("electionResults2015.xlsx")) {
  download.file("http://www.electoralcommission.org.uk/__data/assets/excel_doc/0011/189623/2015-UK-general-election-data-results-WEB.xlsx", "electionResults2015.xlsx")
}

simplifiedConstituencyShapefile <- 
  readRDS("simplifiedShapefile.RDS")

partySelection <- 
  c("Con", "Lab", "UKIP", "SNP", "LD", "Green", "PC", "Ind") 
partyPalette <- 
  c("#0087dc", "#d50000", "#B3009D", "#FFF95D", "#FDBB30", "#8dc63f", 
    "#3F8428", "#d18975") %>%
  set_names(partySelection)

if (!file.exists("votingData.RDS")) {
  candidates <- 
    readxl::read_excel("electionResults2015.xlsx", sheet = 2) %>%
    filter(PANO != is.na(PANO)) %>%
    rename(constituencyId = `Constituency ID`)
  constituency <- 
    readxl::read_excel("electionResults2015.xlsx", sheet = 3) %>%
    filter(PANO != is.na(PANO)) %>%
    rename(
      constituencyId = `Constituency ID`,
      constituencyName = `Constituency Name`
    )
  votingData <- 
    left_join(
      candidates %>%
        select(PANO, Surname, constituencyId, 
          `Party abbreviation`, Votes),
      constituency %>%
        select(PANO, constituencyId, constituencyName, 
          Electorate, `Valid Votes`, Region),
      by = c("PANO", "constituencyId")
    ) %>% 
    filter(PANO != is.na(PANO)) %>%
    rename(
      validVotes = `Valid Votes`,
      partyAbbreviation = `Party abbreviation`
    ) %>%
    filter(partyAbbreviation %in% partySelection) %>%
    mutate(
      partyAbbreviation = 
        factor(partyAbbreviation, levels = partySelection)) %>%
    group_by(PANO) %>%
    mutate(
      resultRank = row_number(desc(Votes)),
      votesPpnElectorate = Votes / Electorate,
      VotesPpnVoted = Votes / validVotes,
      votesPpnLabel = 
        paste0(
          sprintf("%.0f", VotesPpnVoted * 100), "% (", 
          sprintf("%.0f", votesPpnElectorate * 100), "%)"),
      winningVotes = max(Votes),
      shortfallVotes = winningVotes - Votes,
      shortfallVotesPpnElectorate = shortfallVotes / Electorate,
      shortfallVotesPpnVoted = shortfallVotes / validVotes
    ) %>%
    ungroup()
  votingData <- 
    votingData %>%
    left_join(
      votingData %>%
        filter(resultRank == 2) %>%
        mutate(shortfallRank = row_number(shortfallVotesPpnVoted)) %>%
        group_by(Region) %>%
        mutate(shortfallByRegionRank = row_number(shortfallVotesPpnVoted)) %>%
        ungroup() %>%
        select(PANO, shortfallRank, shortfallByRegionRank)
    )
  rm(candidates, constituency)
  saveRDS(votingData, "votingData.RDS")
} else {
  votingData <- readRDS("votingData.RDS")
}

mapVotingData <- 
  votingData %>%
  filter(resultRank <= 3) %>% 
  select(constituencyId, constituencyName, resultRank, partyAbbreviation, 
    shortfallRank) %>%
  spread(key = resultRank, value = partyAbbreviation) %>%
  left_join(
    votingData %>%
      filter(resultRank == 2) %>%
      select(constituencyName, shortfallVotesPpnVoted), 
    by = c("constituencyName")
  )
simplifiedConstituencyShapefile@data <- 
  left_join(
    simplifiedConstituencyShapefile@data, 
    mapVotingData, 
    by = c("CODE" = "constituencyId")
  )

regionList <- unique(votingData$Region)

leafletPalette <- 
    colorNumeric("viridis", 
      domain = simplifiedConstituencyShapefile$shortfallVotesPpnVoted,
      reverse = TRUE
    )

```

Sidebar {.sidebar}
=======================================================================

<br>
```{r}

#Select input for region
selectInput(
  inputId = "regionChoice", label = "Select a region:", 
  choices = regionList, selected = "Scotland"
)

#Filter data based on region data
regionVotingData <- reactive({
  votingData %>%
  filter(Region == input$regionChoice)
})

constituenciesInRegion <- reactive({
  regionData <- regionVotingData()
  unique(regionData$constituencyName)
})

#render ui to select constituecy
output$constituencySelect <- renderUI({
  regionData <- regionVotingData()
  constituencies <- sort(unique(regionData$constituencyName))
  selectInput(
    inputId = "constituencyChoice", label = "Select constituency:",
    choices = constituencies
  )
})
  
uiOutput("constituencySelect")

constituencyVotingData <- reactive({
  req(input$constituencyChoice)
  votingData %>% 
    filter(constituencyName == input$constituencyChoice)
})
```

Whether you have views on Scottish independence or on Brexit, the upcoming election suggests a greater relevance for tactical voting.  

Use the [Explore constituency](#section-explore-constituency) tab to see more detail about your chosen constituency.  

The [Marginal constituencies in region](#section-marginal-constituencies-in-region) tab highlights the top ten marginal contituencies in the selected region.

Explore constituency
=======================================================================

Column
-----------------------------------------------------------------------

### Constituency results

```{r}
output$constituencyChoice <- renderText({
  input$constituencyChoice
})
output$constituencyPlot <- renderPlot({
  constituencyChoice <- input$constituencyChoice
  constituencyData <- constituencyVotingData()
  
  constituencyData %>%
    ggplot() +
    theme_minimal(base_size = 16) +
    labs(
      subtitle = constituencyChoice, 
      caption = 
        paste0(
          scales::ordinal(unique(constituencyData$shortfallByRegionRank)), 
          " most marginal seat in region (",
          scales::ordinal(unique(constituencyData$shortfallRank)), 
          " overall)"
        )) +
    geom_col(
      aes(
        x = partyAbbreviation, 
        y = Votes,
        fill = partyAbbreviation
      )
    ) +
    geom_text(
      aes(
        x = partyAbbreviation, y = Votes, label = votesPpnLabel
      ), size = 4, vjust = 0
    ) +
    scale_fill_manual(values = partyPalette, guide = "none") +
    scale_y_continuous(
      labels = comma, breaks = pretty_breaks(n = 6), expand = c(0.1, 0)) +
    xlab(NULL) + ylab(NULL) + 
    theme(plot.caption = element_text(size = 12))
})
plotOutput("constituencyPlot")
```


Column
-----------------------------------------------------------------------

### Mapping constituencies

```{r}
output$constituencyMap <- renderLeaflet({
  req(input$constituencyChoice)

  constituencyChoice <- input$constituencyChoice
  
  simplifiedConstituencyShapefile@data <-  
    simplifiedConstituencyShapefile@data %>%
    mutate(polygonStroke = 
        ifelse(constituencyName == constituencyChoice, TRUE, FALSE))
  
  selectedData <- 
    subset(simplifiedConstituencyShapefile, 
      constituencyName == constituencyChoice)
  
  labels <- sprintf(
    "<strong>%s</strong><br>First: %s<br>Second: %s (%s)<br>Third: %s",
    simplifiedConstituencyShapefile$constituencyName,
    simplifiedConstituencyShapefile$`1`, 
    simplifiedConstituencyShapefile$`2`,
    paste0(
      round(-100 * simplifiedConstituencyShapefile$shortfallVotesPpnVoted, 0),
      "%"),
    simplifiedConstituencyShapefile$`3`
  ) %>% lapply(htmltools::HTML)
  
  leaflet(data = simplifiedConstituencyShapefile) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    setView(
      mean(selectedData@bbox[1, ]), mean(selectedData@bbox[2, ]), 
      7) %>%
    addPolygons(
      fillColor = ~leafletPalette(shortfallVotesPpnVoted), fillOpacity = 0.6, 
      stroke = TRUE, color = ~ifelse(polygonStroke, "black", "white"), 
      dashArray = ~ifelse(polygonStroke, "", "3"),
      weight = ~ifelse(polygonStroke, 7, 1), 
      label = labels,
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", padding = "3px 8px"),
        textsize = "14px",
        direction = "auto")
    ) %>%
    addLegend(
      pal = leafletPalette, values = ~shortfallVotesPpnVoted, 
      labFormat = labelFormat(suffix = "%", transform = function(x) 100 * x),
      opacity = 0.7, title = "Shortfall", position = "bottomright")
})
leafletOutput("constituencyMap")
```


Marginal constituencies in region
=======================================================================

### Top ten marginal constituencies

About
=======================================================================

### Background  

I put together this app partly because I like playing around with [R](https://cran.r-project.org) and [Shiny](http://shiny.rstudio.com) and also because the upcoming 2017 UK election is likely to be extremely disappointing so I wanted to do something that might potentially be of some small use.  

As someone who sees themselves as Scottish, British and European, I have little time for the parochialism and, in many cases, racism on show in both the Scottish Independence and 'Brexit' debates; and even less time for the rank hypocrisy shown by many politicians.

When it comes to Scotland, it's my view that independence would do far greater harm to the poorest in our society than any austerity measures that the Conservative party in Westminster may enact; there are degrees of harm and, as unfortunate as it is, voting to cut off your foot is better than voting to cut off your leg.

With regard to Europe, I think the blame for how many people feel towards the EU should sit with our own politicians long before we start looking at others. 

If pushed to put a label on it, I would probably characterise my politics as centre-left; I'm typically torn between the Labour party and the Liberal Democrats. And whilst I may disagree with many of their policies, I would note that there are many Conservative MPs whom I respect (the attempt to paint the Conservative party as 'evil monsters' by many in Scotland does nobody any good).

That said, I'm afraid that Labour under Jeremy Corbyn is not something I feel at all comfortable with.

More generally, I would prefer to see far less tribalism and a much greater willingness to seek compromise and collaboration across party lines (for example, as much as I disagree with David Davis on 'Brexit', I respected his stance re civil liberties - more so than could be said for the likes of Andy Burnham).





e

### References

Data sourced from: http://www.electoralcommission.org.uk

Contains OS data &copy; Crown copyright and database right 2017

Flexdashboard layout inspiration: <https://github.com/walkerke/neighborhood_diversity>

Political party colours: <http://blog.richardallen.co.uk/uk-political-party-web-colours/>

```{r, results = "asis"}
citationFn <- function(pkgName = "base") {
  cat(attr(unclass(citation(pkgName))[[1]], "textVersion"), "<br>", "<br>")
}
citationFn() 
citationFn("flexdashboard")
citationFn("shiny")
citationFn("tidyverse")
citationFn("readxl")
citationFn("scales")
citationFn("hrbrthemes")
citationFn("viridis")
citationFn("raster")
citationFn("leaflet")
```


<style>

.section.sidebar {
  background-color: white; 
}

 #muchSmaller { font-size: small; }

</style>
